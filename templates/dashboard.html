{% extends "base.html" %}
{% block title %}Dashboard | Expense Tracker{% endblock %}
{% block content %}

{% if current_user.is_authenticated %}

<!-- Summary cards -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card summary-card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Today’s Spending</div>
        <div class="h4 mb-0">₹ {{ '%.2f'|format(today_total) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card summary-card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">This Month</div>
        <div class="h4 mb-0">₹ {{ '%.2f'|format(month_total) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card summary-card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Overall</div>
        <div class="h4 mb-0">₹ {{ '%.2f'|format(overall_total) }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Category</label>
        <input type="text" name="category" value="{{ category_filter or '' }}" class="form-control" placeholder="e.g. Food">
      </div>
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date or '' }}" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" value="{{ end_date or '' }}" class="form-control">
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary">Filter</button>
        <a href="/" class="btn btn-secondary">Reset</a>
        <a href="/expense/export_csv" class="btn btn-outline-success">⬇ CSV</a>
      </div>
    </form>
  </div>
</div>

<!-- Charts -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">By Category</h6>
        <canvas id="categoryChart" height="170"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Monthly Totals</h6>
        <canvas id="monthChart" height="170"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Table -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="card-title mb-0">Recent Expenses</h6>
      <a class="btn btn-primary btn-sm" href="/expense/add">+ Add Expense</a>
    </div>
    <div class="table-responsive">
      <table class="table table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th class="text-end">Amount (₹)</th>
            <th>Note</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          <tr>
            <td>{{ e.spent_on.strftime('%Y-%m-%d') if e.spent_on else '-' }}</td>
            <td>{{ e.category }}</td>
            <td class="text-end">{{ '%.2f'|format(e.amount) }}</td>
            <td>{{ e.note or '-' }}</td>
            <td class="text-end">
              <a class="btn btn-outline-secondary btn-sm" href="/expense/edit/{{ e.id }}">Edit</a>
              <form action="/expense/delete/{{ e.id }}" method="post" class="d-inline" onsubmit="return confirm('Delete this expense?');">
                <button class="btn btn-outline-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if expenses|length == 0 %}
          <tr><td colspan="5" class="text-center text-muted">No expenses found.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% else %}
  {% include "index.html" %}
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const categoryLabels = {{ category_labels|tojson }};
  const categoryValues = {{ category_values|tojson }};
  const monthLabels = {{ month_labels|tojson }};
  const monthValues = {{ month_values|tojson }};

  if (categoryLabels.length) {
    const ctx1 = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx1, {
      type: 'pie',
      data: { labels: categoryLabels, datasets: [{ data: categoryValues }] }
    });
  }
  if (monthLabels.length) {
    const ctx2 = document.getElementById('monthChart').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: { labels: monthLabels, datasets: [{ label: '₹ Spent', data: monthValues }] },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }
</script>
{% endblock %}
